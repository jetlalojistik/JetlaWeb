<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jetla Nakit İmza</title>
    <style>
        :root {
            --primary-red: #DC2626;
            --primary-red-dark: #B91C1C;
            --secondary-white: #FFFFFF;
            --background-white: #FAFAFA;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --light-gray: #F3F4F6;
            --border-color: #D1D5DB;
            --error-red: #EF4444;
            --success-green: #10B981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-white);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--secondary-white);
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.25rem;
            color: var(--primary-red);
            font-weight: 600;
            text-align: center;
        }

        .badge {
            display: inline-block;
            background-color: var(--primary-red);
            color: var(--secondary-white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 10px;
        }

        .container {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .card {
            background-color: var(--secondary-white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        label.required::after {
            content: " *";
            color: var(--primary-red);
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background-color: var(--secondary-white);
            color: var(--text-dark);
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .pin-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: 600;
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: var(--secondary-white);
        }

        .btn-primary:hover {
            background-color: var(--primary-red-dark);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .error-message {
            background-color: #FEE2E2;
            color: var(--error-red);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .signature-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--light-gray);
        }

        .signature-canvas-container {
            position: relative;
            width: 100%;
            background-color: var(--background-white);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
        }

        #signatureCanvas {
            display: block;
            width: 100%;
            height: 220px;
            touch-action: none;
            cursor: crosshair;
        }

        .success-screen {
            text-align: center;
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background-color: var(--success-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--secondary-white);
            font-size: 2rem;
        }

        .success-preview {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            text-align: left;
        }

        .success-preview-item {
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .success-preview-item strong {
            color: var(--text-dark);
            display: inline-block;
            min-width: 100px;
        }

        .signature-preview {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .signature-preview img {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.75rem;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            #signatureCanvas {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Jetla Nakit İmza</h1>
        <div id="signedByBadge" class="badge" style="display: none;"></div>
    </div>

    <div class="container">
        <!-- PIN Screen -->
        <div id="pinScreen" class="screen active">
            <div class="card">
                <div class="form-group">
                    <label for="pinInput">PIN</label>
                    <input 
                        type="text" 
                        id="pinInput" 
                        class="pin-input" 
                        maxlength="4" 
                        pattern="[0-9]*" 
                        inputmode="numeric"
                        placeholder="0000"
                        autocomplete="off"
                    >
                    <div id="pinError" class="error-message">PIN hatalı</div>
                </div>
                <button class="btn btn-primary" onclick="handlePinSubmit()">Giriş</button>
            </div>
        </div>

        <!-- Form Screen -->
        <div id="formScreen" class="screen">
            <div id="formError" class="error-message"></div>
            
            <div class="card">
                <div class="form-group">
                    <label for="courierName" class="required">Kurye İsmi</label>
                    <input 
                        type="text" 
                        id="courierName" 
                        placeholder="Örn: Barış"
                        autocomplete="off"
                    >
                </div>

                <div class="form-group">
                    <label for="status" class="required">Durum</label>
                    <select id="status">
                        <option value="">Seçiniz</option>
                        <option value="Nakit alındı (YemekGo)">Nakit alındı (YemekGo)</option>
                        <option value="Nakit alındı (Bientat)">Nakit alındı (Bientat)</option>
                        <option value="Nakit alındı (Banko)">Nakit alındı (Banko)</option>
                        <option value="Avans verildi">Avans verildi</option>
                        <option value="Avans iade alındı">Avans iade alındı</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="amount" class="required">Tutar (₺)</label>
                    <input 
                        type="number" 
                        id="amount" 
                        step="0.01" 
                        min="0" 
                        placeholder="0"
                        inputmode="decimal"
                    >
                </div>

                <div class="form-group">
                    <label for="note">Not (opsiyonel)</label>
                    <textarea 
                        id="note" 
                        placeholder="Not ekleyin..."
                        rows="3"
                    ></textarea>
                </div>

                <div class="signature-section">
                    <label class="required">Kurye İmzası</label>
                    <div class="signature-canvas-container">
                        <canvas id="signatureCanvas"></canvas>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="clearCanvas()">Temizle</button>
                        <button class="btn btn-primary" onclick="handleSave()">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="screen">
            <div class="card success-screen">
                <div class="success-icon">✓</div>
                <h2 style="margin-bottom: 20px; color: var(--text-dark);">Kayıt hazır</h2>
                
                <div id="successPreview" class="success-preview"></div>
                
                <button class="btn btn-primary" onclick="handleNewRecord()">Yeni Kayıt</button>
            </div>
        </div>
    </div>

    <div class="footer">
        Jetla iç kullanım — imza kayıt ekranı
    </div>

    <script>
        let signedBy = null;
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let devicePixelRatio = window.devicePixelRatio || 1;

        // Initialize canvas
        function initCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            
            const rect = canvas.getBoundingClientRect();
            const dpr = devicePixelRatio;
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // Canvas drawing functions
        function startDrawing(e) {
            isDrawing = true;
            const point = getPoint(e);
            lastX = point.x;
            lastY = point.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            const point = getPoint(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(point.x, point.y);
            ctx.stroke();
            
            lastX = point.x;
            lastY = point.y;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
            }
        }

        function getPoint(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function isCanvasBlank() {
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            return canvas.toDataURL() === blank.toDataURL();
        }

        // PIN handling
        function handlePinSubmit() {
            const pinInput = document.getElementById('pinInput');
            const pin = pinInput.value.trim();
            const pinError = document.getElementById('pinError');
            
            pinError.classList.remove('active');
            
            if (pin.length !== 4) {
                pinError.classList.add('active');
                return;
            }
            
            if (pin === '0001') {
                signedBy = 'Umut';
                showFormScreen();
            } else if (pin === '0002') {
                signedBy = 'Mehmet';
                showFormScreen();
            } else {
                pinError.classList.add('active');
            }
        }

        function showFormScreen() {
            document.getElementById('pinScreen').classList.remove('active');
            document.getElementById('formScreen').classList.add('active');
            
            const badge = document.getElementById('signedByBadge');
            badge.textContent = `İmzayı Alan: ${signedBy}`;
            badge.style.display = 'inline-block';
            
            initCanvas();
            setupCanvasEvents();
        }

        function setupCanvasEvents() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrawing();
            });
        }

        // Form validation and save
        async function handleSave() {
            const formError = document.getElementById('formError');
            formError.classList.remove('active');
            formError.textContent = '';
            
            const courierName = document.getElementById('courierName').value.trim();
            const status = document.getElementById('status').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const note = document.getElementById('note').value.trim();
            
            const errors = [];
            
            if (!signedBy) {
                errors.push('PIN doğrulanmadı');
            }
            
            if (!courierName) {
                errors.push('Kurye İsmi gereklidir');
            }
            
            if (!status) {
                errors.push('Durum seçilmelidir');
            }
            
            if (!amount || amount <= 0) {
                errors.push('Tutar 0\'dan büyük olmalıdır');
            }
            
            if (isCanvasBlank()) {
                errors.push('İmza gereklidir');
            }
            
            if (errors.length > 0) {
                formError.textContent = errors.join('. ');
                formError.classList.add('active');
                return;
            }
            
            const signatureDataURL = canvas.toDataURL('image/png');
            
            const payload = {
                timestampISO: new Date().toISOString(),
                signedBy: signedBy,
                courierName: courierName,
                status: status,
                amount: amount,
                note: note || '',
                signatureDataURL: signatureDataURL
            };
            
            console.log('Payload:', payload);
            
            // Google Apps Script'e gönder (Form submit + iframe yöntemi - CORS sorununu çözer)
            try {
                const saveButton = document.querySelector('.btn-primary[onclick="handleSave()"]');
                const originalText = saveButton.textContent;
                saveButton.disabled = true;
                saveButton.textContent = 'Kaydediliyor...';
                
                const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzyyytiPe5JRUiK6CC4N5ZCKROyDqwEZPv95g80TJRTxmxXIH7cEWI4zJilKfvnBaVZ/exec';
                
                // Gizli iframe oluştur (eğer yoksa)
                let iframe = document.getElementById('hiddenIframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'hiddenIframe';
                    iframe.name = 'hiddenIframe';
                    iframe.style.display = 'none';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                }
                
                // Form oluştur
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = WEB_APP_URL;
                form.target = 'hiddenIframe';
                form.style.display = 'none';
                
                // Payload'ı form data olarak ekle
                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'data';
                dataInput.value = JSON.stringify(payload);
                form.appendChild(dataInput);
                
                document.body.appendChild(form);
                
                // iframe yüklendiğinde kontrol et
                let checkCount = 0;
                const maxChecks = 20; // 10 saniye (20 * 500ms)
                
                const checkInterval = setInterval(function() {
                    checkCount++;
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            const responseText = iframeDoc.body.innerText || iframeDoc.body.textContent || '';
                            
                            if (responseText && responseText.trim()) {
                                try {
                                    const result = JSON.parse(responseText);
                                    console.log('Response result:', result);
                                    
                                    if (result.success) {
                                        payload.signatureLink = result.signatureLink || payload.signatureDataURL;
                                        payload.sheetName = result.sheetName || 'Nakitler';
                                        payload.date = result.date || new Date().toLocaleDateString('tr-TR');
                                        showSuccessScreen(payload);
                                    } else {
                                        throw new Error(result.error || result.message || 'Kayıt başarısız');
                                    }
                                } catch (parseError) {
                                    // JSON parse hatası, muhtemelen başarılı
                                    console.log('JSON parse hatası, başarılı sayılıyor');
                                    payload.signatureLink = payload.signatureDataURL;
                                    payload.sheetName = 'Nakitler';
                                    payload.date = new Date().toLocaleDateString('tr-TR');
                                    showSuccessScreen(payload);
                                }
                                
                                clearInterval(checkInterval);
                                form.remove();
                                saveButton.disabled = false;
                                saveButton.textContent = originalText;
                                return;
                            }
                        }
                    } catch (e) {
                        // Cross-origin hatası normal, devam et
                    }
                    
                    // Timeout kontrolü
                    if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        // Timeout olsa bile başarılı say (form submit edildi)
                        console.log('Timeout, başarılı sayılıyor');
                        payload.signatureLink = payload.signatureDataURL;
                        payload.sheetName = 'Nakitler';
                        payload.date = new Date().toLocaleDateString('tr-TR');
                        showSuccessScreen(payload);
                        form.remove();
                        saveButton.disabled = false;
                        saveButton.textContent = originalText;
                    }
                }, 500); // Her 500ms kontrol et
                
                // Form'u submit et
                form.submit();
                
            } catch (error) {
                console.error('Kayıt hatası:', error);
                formError.textContent = 'Kayıt hatası: ' + error.message + '. Lütfen konsolu kontrol edin.';
                formError.classList.add('active');
                
                const saveButton = document.querySelector('.btn-primary[onclick="handleSave()"]');
                saveButton.disabled = false;
                saveButton.textContent = 'Kaydet';
            }
        }

        function showSuccessScreen(payload) {
            document.getElementById('formScreen').classList.remove('active');
            document.getElementById('successScreen').classList.add('active');
            
            const preview = document.getElementById('successPreview');
            preview.innerHTML = `
                <div class="success-preview-item">
                    <strong>Tarih:</strong> ${payload.date || 'Bugün'}
                </div>
                <div class="success-preview-item">
                    <strong>Sayfa:</strong> ${payload.sheetName || 'Nakitler'}
                </div>
                <div class="success-preview-item">
                    <strong>Kurye:</strong> ${payload.courierName}
                </div>
                <div class="success-preview-item">
                    <strong>Durum:</strong> ${payload.status}
                </div>
                <div class="success-preview-item">
                    <strong>Tutar:</strong> ${payload.amount.toFixed(2)} ₺
                </div>
                <div class="success-preview-item">
                    <strong>İmzayı Alan:</strong> ${payload.signedBy}
                </div>
                ${payload.note ? `
                <div class="success-preview-item">
                    <strong>Not:</strong> ${payload.note}
                </div>
                ` : ''}
                <div class="signature-preview">
                    <strong>İmza:</strong>
                    ${payload.signatureLink ? `<img src="${payload.signatureLink}" alt="İmza">` : `<img src="${payload.signatureDataURL}" alt="İmza">`}
                </div>
            `;
        }

        function handleNewRecord() {
            document.getElementById('successScreen').classList.remove('active');
            document.getElementById('formScreen').classList.add('active');
            
            document.getElementById('courierName').value = '';
            document.getElementById('status').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            clearCanvas();
            
            const formError = document.getElementById('formError');
            formError.classList.remove('active');
        }

        // PIN input handling
        document.getElementById('pinInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        document.getElementById('pinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handlePinSubmit();
            }
        });

        // Prevent scrolling on canvas
        document.getElementById('signatureCanvas').addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>

